generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String             @id @default(uuid())
  email         String             @unique
  password      String
  phone         String?
  avatar        String?
  role          Role               @default(USER)
  refreshToken  String?            @map("refresh_token")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  name          String             @db.VarChar(100)
  bookings      Booking[]
  conversations ChatConversation[]
  reviews       Review[]

  @@map("users")
}

model Hotel {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  description  String?
  address      String
  city         String
  country      String
  latitude     Float?
  longitude    Float?
  stars        Int      @default(0)
  rating       Float    @default(0)
  reviewCount  Int      @default(0) @map("review_count")
  amenities    String[] @default([])
  images       String[] @default([])
  contactEmail String?  @map("contact_email")
  contactPhone String?  @map("contact_phone")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  reviews      Review[]
  rooms        Room[]

  @@index([city])
  @@index([country])
  @@index([rating])
  @@index([stars])
  @@map("hotels")
}

model Room {
  id           String             @id @default(uuid())
  hotelId      String             @map("hotel_id")
  name         String
  description  String?
  type         String
  price        Float
  currency     String             @default("USD")
  maxGuests    Int                @default(2) @map("max_guests")
  amenities    String[]           @default([])
  images       String[]           @default([])
  isActive     Boolean            @default(true) @map("is_active")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  bookings     Booking[]
  availability RoomAvailability[]
  hotel        Hotel              @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  @@index([hotelId])
  @@index([price])
  @@index([type])
  @@map("rooms")
}

model RoomAvailability {
  id          String   @id @default(uuid())
  roomId      String   @map("room_id")
  date        DateTime @db.Date
  isAvailable Boolean  @default(true) @map("is_available")
  price       Float?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  room        Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, date])
  @@index([date])
  @@index([isAvailable])
  @@map("room_availability")
}

model Booking {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  roomId          String        @map("room_id")
  checkIn         DateTime      @map("check_in") @db.Date
  checkOut        DateTime      @map("check_out") @db.Date
  guests          Int           @default(1)
  totalPrice      Float         @map("total_price")
  currency        String        @default("USD")
  status          BookingStatus @default(PENDING)
  specialRequests String?       @map("special_requests")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  room            Room          @relation(fields: [roomId], references: [id])
  user            User          @relation(fields: [userId], references: [id])
  payment         Payment?

  @@index([userId])
  @@index([roomId])
  @@index([status])
  @@index([checkIn, checkOut])
  @@map("bookings")
}

model Payment {
  id                String        @id @default(uuid())
  bookingId         String        @unique @map("booking_id")
  transactionId     String?       @unique @map("transaction_id")
  amount            Float
  currency          String        @default("USD")
  status            PaymentStatus @default(PENDING)
  method            String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  booking           Booking       @relation(fields: [bookingId], references: [id])

  @@index([status])
  @@map("payments")
}

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  hotelId   String   @map("hotel_id")
  rating    Int
  title     String?
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, hotelId])
  @@index([hotelId])
  @@index([rating])
  @@map("reviews")
}

model ChatConversation {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  title     String        @default("New conversation")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@index([userId])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String           @map("conversation_id")
  role           MessageRole
  content        String
  createdAt      DateTime         @default(now()) @map("created_at")
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("chat_messages")
}

enum Role {
  USER
  ADMIN
  HOTEL_OWNER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum MessageRole {
  USER
  ASSISTANT
}

model CrawlJob {
  id             String      @id @default(uuid())
  url            String
  status         CrawlStatus @default(PENDING)
  extractReviews Boolean     @default(false) @map("extract_reviews")
  hotelId        String?     @map("hotel_id")
  result         Json?
  error          String?
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  @@index([status])
  @@map("crawl_jobs")
}

enum CrawlStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}
